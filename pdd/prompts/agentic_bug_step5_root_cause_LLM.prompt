<pdd-reason>Analyzes bug root cause with cross-cutting concern detection for better fix guidance.</pdd-reason>

% You are an expert software engineer investigating a bug report. Your task is to analyze the root cause of the issue.

% Context

You are working on step 5 of 11 in an agentic bug investigation workflow. Previous steps have triaged, attempted reproduction, and gathered context.

% Inputs

- GitHub Issue URL: {issue_url}
- Repository: {repo_owner}/{repo_name}
- Issue Number: {issue_number}

% Issue Content
<issue_content>
{issue_content}
</issue_content>

% Previous Steps Output
<step1_output>
{step1_output}
</step1_output>

<step2_output>
{step2_output}
</step2_output>

<step3_output>
{step3_output}
</step3_output>

<step4_output>
{step4_output}
</step4_output>

% Your Task

1. **Analyze the code path**
   - Read the affected files identified in reproduction
   - Trace the execution flow that leads to the error
   - Understand the data flow and transformations

2. **Research external sources**
   - Search for the error message or symptoms online
   - Check if the issue relates to a known bug in dependencies
   - Look for similar issues in library/framework documentation
   - Search GitHub issues, StackOverflow, or forums for related problems
   - Note any relevant version constraints or breaking changes

3. **Analyze repository history**
   - Use `git log` and `git blame` on affected files to identify when problematic code was introduced
   - Search for related PRs that modified this code: `gh pr list --search "keyword" --state all`
   - Review PR discussions for context on why changes were made
   - Check closed issues for similar (not just duplicate) problems that provide historical insight
   - Look for recent commits that might correlate with the bug's first appearance

4. **Identify the root cause**
   - What condition triggers the bug?
   - Is it a logic error, edge case, race condition, or incorrect assumption?

5. **Explore existing patterns in the codebase**
   - Search the codebase for how similar problems are already handled
   - Example: if the bug is "user type X doesn't get redirected correctly," search for how other user types ARE redirected and where that logic lives
   - If an existing pattern already solves an analogous case, the fix should extend that same pattern — not introduce a new approach
   - Trace the bug to its TRUE root cause — don't stop at the component where symptoms appear. If component A is stuck on the wrong page, the root cause may be in component B's routing logic, not in component A itself

6. **Run experiments**
   - Add debug output or modify code temporarily to verify hypotheses
   - Test edge cases and boundary conditions
   - Confirm your understanding of why the bug occurs

7. **Document the root cause**
   - Explain the bug in clear terms
   - Identify the specific line(s) or logic that need to change
   - Note any related issues or implications

8. **Assess fix scope: localized vs cross-cutting**
   Determine whether the fix is localized to one function/module or requires a cross-cutting solution:
   - **Localized**: The bug is in one function and can be fixed by modifying that function alone. Example: a wrong index, missing null check, incorrect calculation.
   - **Cross-cutting**: The bug affects a concern that spans many call sites, and a per-function fix would mean modifying 5+ locations with the same pattern. Examples:
     - A CLI flag (like --quiet, --verbose, --dry-run) that needs to be threaded through many functions → fix should be a centralized mechanism (env var, context object, global module), not adding a parameter to every function
     - A configuration value read in many places → fix should be a config singleton or context, not passing the value through every call chain
     - Error handling missing in many endpoints → fix should be centralized middleware or decorator, not adding try/catch to each one
     - A state check needed at many call sites → fix should be a single check at the entry point or a decorator
   If cross-cutting, note this in your root cause analysis and recommend the centralized approach. The fix may require creating a new module or utility, not just modifying existing code.


% Output

After completing your analysis, use `gh issue comment` to post your findings to issue #{issue_number}:

```
gh issue comment {issue_number} --repo {repo_owner}/{repo_name} --body "..."
```

Your comment should follow this format:

```markdown
## Step 5: Root Cause Analysis

**Root Cause Identified:** [Yes | Partially | No]

### Summary
[One-paragraph explanation of what causes the bug]

### Technical Details
- **Location:** `path/to/file.py:123`
- **Problematic Code:**
```python
# The issue is here
problematic_code_snippet()
```
- **Why it fails:** [Explanation]

### External Research
- **Search terms:** [key terms searched]
- **Sources checked:** [GitHub, StackOverflow, docs, etc.]
- **Relevant findings:** [any related issues, known bugs, or workarounds found]

### Repository History
- **Relevant commits:** [commits that introduced or modified the problematic code]
- **Related PRs:** [PRs that touch the affected code path, with discussion context]
- **Similar past issues:** [closed issues with related symptoms or fixes]

### Experiments Performed
1. [What you tested and what it revealed]
2. ...

### Fix Scope
- **Type:** [Localized | Cross-cutting]
- [If cross-cutting]: **Affected call sites:** [List the 5+ locations that would need the same change]
- [If cross-cutting]: **Centralized approach:** [Describe the single mechanism — env var, context object, new utility module, decorator — that would solve it in one place instead of N changes]
- [If cross-cutting]: **New file needed?** [Yes/No — e.g., a `quiet.py` module, a config singleton, a middleware]

### Fix Location
- **File(s) to modify:** `path/to/root_cause_file.py`
- **Why this location:** [Explain why this is the root cause, not just where symptoms appear]
- **Existing pattern:** [Reference the analogous case in the codebase that already works correctly]
- **Fix approach:** [How to extend the existing pattern to cover this case]

---
*Proceeding to Step 5.5: Prompt Classification*
```

% Important

- Be specific about the exact location and nature of the bug
- Trace to the TRUE root cause — the component where symptoms appear is often not the right place to fix
- Search for existing patterns that solve analogous problems before recommending a fix approach
- The fix location you recommend here directly determines which component pdd bug will create tests for — getting this wrong means tests will target the wrong code
- If root cause is unclear, document what you learned and hypotheses
- **Cross-cutting check**: Count how many call sites would need the same change. If 5+, stop and think about a centralized solution. A fix that patches 10 functions with the same `if not flag:` guard is a code smell — the right fix is usually one mechanism at a higher level.
- Always post your findings as a GitHub comment before completing
